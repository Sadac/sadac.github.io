---
import Button from '@/components/Button.astro'
import PageLayout from '@/layouts/BaseLayout.astro'
import { getAllPosts, getUniqueTagsWithCount } from '@/utils'

const allPosts = await getAllPosts()
const allTags = getUniqueTagsWithCount(allPosts)

// Filter out draft posts for accurate tag counts
const publishedPosts = allPosts.filter((post) => post.data.draft !== true)
const publishedTags = getUniqueTagsWithCount(publishedPosts)

const meta = {
	description: "Explore all the topics and categories I've written about in my blog posts",
	title: 'All Tags & Topics'
}
---

<PageLayout meta={meta}>
	<div class='w-full'>
		<Button title='Back' href='/blog' style='button'>
			<svg
				xmlns='http://www.w3.org/2000/svg'
				width='14'
				height='14'
				viewBox='0 0 24 24'
				slot='icon-before'
			>
				<path
					fill='currentColor'
					d='m6.921 12.5l5.792 5.792L12 19l-7-7l7-7l.713.708L6.921 11.5H19v1z'
				>
				</path>
			</svg>
		</Button>

		<h1 class='mb-6 mt-5 text-2xl font-bold'>All Tags</h1>

		{/* Tags Section */}
		{publishedTags.length === 0 ? (
			<div class='text-center py-12'>
				<p class='text-muted-foreground'>No posts yet.</p>
			</div>
		) : (
			<section>

				{/* Tags Grid */}
				<div class='flex flex-wrap gap-3'>
					{publishedTags.map(([tag, count]) => (
						<Button
							title={`${tag} (${count} post${count > 1 ? 's' : ''})`}
							href={`/tags/${tag}/`}
							style='pill'
							data-astro-prefetch
						>
							<span class='flex items-center gap-2'>
								<span>#{tag}</span>
								<span class='text-xs opacity-75'>({count})</span>
							</span>
						</Button>
					))}
				</div>

				{/* Most Popular Tags */}
				{publishedTags.length > 5 && (
					<div class='mt-8'>
						<h3 class='mb-4 text-lg font-medium'>Most Popular</h3>
						<div class='flex flex-wrap gap-2'>
							{publishedTags
								.sort(([,a], [,b]) => b - a)
								.slice(0, 5)
								.map(([tag, count]) => (
									<Button
										title={`${tag} (${count} post${count > 1 ? 's' : ''})`}
										href={`/tags/${tag}/`}
										style='pill'
										data-astro-prefetch
									>
										<span class='flex items-center gap-2'>
											<span>#{tag}</span>
											<span class='text-xs opacity-75 font-bold'>{count}</span>
										</span>
									</Button>
								))
							}
						</div>
					</div>
				)}
			</section>
		)}
	</div>
</PageLayout>
